!function(t,e,a,s){function n(t){this.element=t,this.plugin,this.loaded,this.loading,this.response,this.logo,this.menuBar,this.genre,this.genres,this.spinner,this.featured,this.lightBox,this.playNow,this.lightBoxTarget,this.lightBoxClose,this.searchBox,this.includesPath,this.totalFiles,this.messageContainer,this.messageContent,this.progressBar,this.movieHolder,this.movieCard,this.windowMargin,this.init()}function o(e,a){var i=t.ajax({type:a,url:"bootstrap.php",data:e,dataType:"json"});return i.fail(function(t){l(t.responseText)}),i}function l(t){var e='<i class="fa fa-exclamation-triangle"></i> Error',a="<strong>Message:</strong> "+t+'<div step-id="4" class="button step" id="installButton">Try Again</div>';return r(a,e),clearInterval(progressBar),!1}function r(e,a){t(windowMargin).hide(),t("body").load(includesPath+" "+messageContainer,function(){var i=t(".top").find(" h1");a&&i.html(a),t(messageContent).html(e)}).addClass("container")}function d(){location.reload()}var c="PopStop";n.prototype={init:function(){$movieContainer=t(this.element),loaded=0,genres=0,plugin=this,loading=!1,includesPath="/app/public/templates/includes.html";var i=t(a),s=t(e);this.getIDs(),this.isInstalled(),s.on("scroll",function(){plugin.onScroll()}),t(sideBar).find(".sort-by li").on("click",function(){$this=t(this),plugin.sortBy($this)}),i.on("click",".movie, .featured-movie",function(){var e=t(this);plugin.openLightBox(e)}),i.on("click",lightBoxClose,function(t){t.preventDefault(),plugin.closeLightBox()}),i.on("click",playNow,function(){plugin.startMovie()}),i.on("click",".tag, .genre, .cast",function(e){e.preventDefault();var a=t(this),i="cast"==t(this).attr("class")?"cast":"genre";plugin.getGenreOrCast(i,a)}),t("#side-menu-toggle").on("click",function(){var e=t(this);e.toggleClass("active"),t("body").toggleClass("side-bar-open");var a=t(sideBar).height();t(movieContainer).css(t(sideBar).is(":visible")?{"min-height":a}:{"min-height":0})}),t(searchBox).on("keyup",function(){plugin.onSearch()}),t(menuBar).find(".settings").on("click",function(){plugin.showSettings()}),i.on("click","#saveSettings",function(){plugin.saveSettings()}),i.on("click","#installButton",function(){var e=t(this),a=e.attr("step-id");plugin.installationProcess(a,!1)}),i.on("click","#updateAgain",function(){plugin.updateMovies()}),i.on("click","#confirmKey",function(){var e=t(messageContent).find("input").val();plugin.confirmApiKey(e)}),i.on("click","#passwordField",function(){var e=t(this),a=t("#enterPassword");e.is(":checked")?a.fadeIn(1e3):a.fadeOut(1e3)}),i.on("click","#loginConfirm",function(){plugin.verifyPassword()})},isInstalled:function(){var e={"function":"isInstalled"};o(e,"GET",!1).done(function(e){var a=t(movieContainer);a.attr("data-total",e.total_files),e.is_installed?e.password?plugin.showLogin():e.is_updated?e.is_clean?plugin.cleanDatabase():(t(windowMargin).fadeIn(2e3),plugin.getFeatured(),plugin.getMovies(),plugin.showGenres()):plugin.updateMovies():plugin.installationProcess()}),totalFiles=$movieContainer.attr("data-total")},getIDs:function(){logo=".logo",menuBar=".menu-bar",sideBar=".side-bar",spinner=".spinner",featured=".featured-movie",lightBox="#lightBox",playNow="#playNow",lightBoxTarget="#lightboxTarget",lightBoxClose=".lightbox-close",movieHolder="#movieHolder",movieCard=".movie-card",searchBox="#searchBox",messageContainer="#messageContainer",messageContent=".content",windowMargin=".window-margin"},showStars:function(t){var t=t.split("/"),e='<div class="stars">';for(i=0;i<t[0];i++)e+='<span class="fa fa-star"></span>';for(t[1]>0&&(e+='<span class="fa fa-star-half-o"></span>'),i=0;i<t[2];i++)e+='<span class="fa fa-star-o"></span>';return e+="</div>"},getFeatured:function(){var e={"function":"getFeaturedMovie",track:loaded,type:t(movieContainer).attr("data-type")};o(e,"GET",!1).done(function(e){var a=e.release_date.split("-")[0],i=plugin.showStars(e.stars),s='<div class="bottom-bar"><div class="title-container"><b>'+e.title+" ("+a+')</b></div><div class="right">'+i+"</div></div>";t(featured).css("background-image","url("+e.backdrop_path+")").attr("movie-id",e.movie_id).html(s)})},getMovies:function(e){t(windowMargin).addClass("loading");var a=t(movieContainer),i=a.attr("data-type");genre=a.attr("data-genre"),cast=a.attr("data-cast");var s={"function":"getMovies",is_loaded:loaded,type:i,genre:genre,cast:cast};o(s,"GET",!1).done(function(i){var s="";t.each(i.movies,function(t,e){s+='<li class="movie" movie-id="'+e.movie_id+'"><img src="'+e.poster_path+'" alt="'+e.title+'" /></li>'}),e===!0?a.append(s):a.html(s),loaded=0==loaded?i.batch:parseFloat(loaded)+parseFloat(i.batch),a.attr("data-loaded",loaded),t(windowMargin).removeClass("loading")}),loaded=a.attr("data-loaded"),totalFiles=a.attr("data-total")},sortBy:function(e){type=e.find("a").attr("data-type"),loaded=0,$movieContainer.attr("data-loaded",loaded),t(movieContainer).attr("data-type",type),t(sideBar).find(".sort-by li").removeClass("selected"),e.addClass("selected"),this.getMovies()},getGenreOrCast:function(e,a){var i=t(movieContainer);switch(loaded=0,i.attr("data-loaded",loaded),totalFiles=a.attr("data-total"),i.attr("data-total",totalFiles),e){case"genre":genre=a.attr("data-genre"),t(sideBar).find("#genresList li").removeClass("selected"),t(sideBar).find('#genresList li a[data-genre="'+genre+'"]').closest("li").addClass("selected"),i.attr("data-genre",genre),i.attr("data-cast","");break;case"cast":var s=a.attr("data-cast");i.attr("data-cast",s)}this.getMovies(),this.closeLightBox()},showGenres:function(){if(0==t("ul#genresList li").length){var e={"function":"getMovieGenres"};o(e,"GET",!1).done(function(e){var a='<li class="selected"><a class="genre" data-genre="" data-total="'+totalFiles+'">Show All ('+totalFiles+")</a></li>";t.each(e,function(t,e){a+='<li> <a class="genre" data-genre="'+t+'" data-total="'+e+'">'+t+" ("+e+")</a></li>"}),t("#genresList").html(a)})}},onSearch:function(){var e=t(searchBox).val();if(e.length>0){var a={"function":"searchMovies",query:e};o(a,"POST",!1).done(function(a){if(loading=!0,a==s||null==a||0==a.length)t(movieContainer).html('<div class="no-results"><p><i class="fa fa-search"></i> Oops there are no search results for '+e+"..</p></div>");else{var i="";t.each(a,function(t,e){i+='<li class="movie" movie-id="'+e.movie_id+'"><img src="'+e.poster_path+'" alt="'+e.title+'" /></li>'}),t(movieContainer).html(i)}})}else 0===e.length&&(loaded=0,loading=!1,this.getMovies())},openLightBox:function(e){var a=e.attr("movie-id"),s={"function":"getMovieById",id:a};o(s,"GET",!1).done(function(e){var s=plugin.showStars(e.stars),n=e.release_date.split("-")[0],l=e.genres.split(",");t(lightBox).load(includesPath+" "+lightBoxTarget,function(){var r=t(".hero"),d=t("#cover"),c=t(".column-left"),p=t("#overview"),u=t("#cast"),h=t(".details"),v='<span class="runtime"><b><span class="fa fa-clock-o"></span></b> '+e.runtime+' minutes<br></span><div class="tags">';i=0,t.each(l,function(e,a){var s=t(sideBar).find('#genresList li a[data-genre="'+a+'"]').attr("data-total");v+='<span class="tag" data-genre="'+a+'" data-total="'+s+'">'+a+"</span>",i%2&&(v+="<br>"),i++}),v+="</div>";var f='<div class="bottom-bar"><div class="title-container"><b>'+e.title+" ("+n+')</b></div><div class="right">'+s+"</div></div>";t(movieHolder).attr("data-id",e.movie_id),r.css("background-image","url("+e.cover_path+")"),d.html('<img src="'+e.poster_path+'" alt="cover" class="cover" />'),p.html("<p>"+e.overview+"</p>"),c.html(v),h.html(f),u.html("");var g={"function":"getMovieCastById",id:a};if(o(g,"GET",!1).done(function(e){var a="<ul>";t.each(e.casts,function(t,e){var i=e.profile_path.length>0?e.profile_path:"app/public/images/no-image.jpg";a+='<li class="cast" data-cast="'+e.cast_id+'"><div class="image-wrap"><img src="'+i+'"></div><span>'+e.name+"</span></li>"}),a+="</ul>",u.html(a)}),null!==e.resume_at){console.log(e.resume_at);var m=0==e.resume_at?"WATCH AGAIN":"RESUME";t(playNow).html('<i class="fa fa-play-circle"></i> '+m)}t(lightBoxTarget).css({opacity:"1",top:"0",bottom:"0","z-index":"10000"})})})},closeLightBox:function(){t(lightBoxTarget).remove()},startMovie:function(){var e={"function":"playMovie",id:t(movieHolder).attr("data-id")};o(e,"GET",!1).done(function(e){t(movieHolder).html('<video autoplay="autoplay"><source src="'+e.target+'"></video>'),t("video").PopStopPlayer({movieId:e.movie_id,posterPath:e.poster_path,title:e.title,year:e.release_date.split("-")[0],stars:plugin.showStars(e.stars),autoPlay:!0,resumeTime:null===e.resume_at?0:e.resume_at,basePath:e.path})})},onScroll:function(){var i=t(menuBar),s=t(sideBar),n=t(logo),o=t(a).height(),l=t(e).height(),r=t(e).scrollTop(),d=t(featured).height();r>=d?(i.addClass("menu-bar-sticky"),s.addClass("side-bar-sticky"),n.addClass("logo-sticky")):d>r&&(s.removeClass("side-bar-sticky"),i.removeClass("menu-bar-sticky"),n.removeClass("logo-sticky")),r+l===o&&parseFloat(loaded)<=parseFloat(totalFiles)&&(loading=!0,plugin.getMovies(!0))},confirmApiKey:function(e){e.length>0&&(data={"function":"confirmApiKey",key:e},o(data,"POST",!1).done(function(a){if(a.status){var i={"function":"saveApiKey",key:e};o(i,"POST",!1).done(function(t){t.saved&&plugin.startInstallation(3)})}else t(messageContent).find("input").css("border","2px solid #F94F6A"),t(messageContent).find(".error").html("The API-KEY is not valid, make sure you insert a valid key and that the key is activated.").css({color:"#F94F6A","font-weight":"bold"})})),t("input").css("border","2px solid #F94F6A")},installationProcess:function(e){var a="";switch(e){case"1":a='<p>To fetch the movie information from the TMDB api you need to have a <strong>key</strong>, you can create a free account <a href="https://www.themoviedb.org/account/signup" target="_blank">here.</a> </p><p><div class="api-key"> <span class="fa fa-key"></span> <input placeholder="API-KEY"></div></p><p class="error"></p><div step-id="2" class="button step" id="confirmKey">Confirm</div>';break;case"2":a="<p>We have detected <strong>"+totalFiles+'</strong> files in the content directory.The next step will fetch the movie information for each file, depending on the number of files this might take a while.<div step-id="3" class="button step" id="installButton">continue</div>';break;case"3":plugin.startInstallation();break;case"4":d();break;case"5":a='<p>Are you sure you want to clear the database and do a rescan of the content directory?</p><p>This action can\'t be undone.</p><div step-id="4" class="button step" id="installButton" style="left:10px">Go Back</div><div step-id="3" class="button step" id="installButton">Confirm</div>';break;case"6":a='<p>Hooray the script has finished successfully! It\'s time to grab some popcorn and enjoy your movie collection.</p><div step-id="4" class="button step" id="installButton">Finish</div>';break;case"7":plugin.updateMovies();break;case"8":a='<p>Whenever you delete a file it will remain in the database, this will remove the entries in the database. This won\'t delete any files in the content directory.</p><div step-id="9" class="button step" id="installButton">Start</div>';break;case"9":plugin.cleanDatabase();break;default:var i='<i class="fa fa-cube"></i> Installation';a='<p>Before you can stream your movies we first have to locate them and fetch the movie information. If you have done everything on the list below you can go to the next step.</p><ul><li>Add your movies to the content Directory. Copy them over or even better create a symlink.</li><li>Make sure the <code>app/database</code> folder is writable.</li><li>Rename your files with the title of the movie, for better results add the year of the movie. </li></ul><div step-id="1" class="button step" id="installButton">Continue</div>',r(a,i)}t(messageContent).html(a)},startInstallation:function(){var e='<i class="fa fa-cube"></i> Installation',a='<p>Fetching the movie information please wait..<p><div class="progress"><span class="progress-val">0%</span><span class="progress-bar"><span class="progress-in"></span></span></div><br><br><p>Don\'t close this window and wait until the script is finished.</p>';r(a,e);var i={"function":"installFiles"};o(i,"GET",!1).done(function(e){if(e.not_found){clearInterval(progressBar);for(var a=e.files,i="<p>The script was not able to fetch the movie information for the following files:</p><ul>",s=0;s<a.length;s++)i+="<li>"+a[s].file+"</li>";i+='</ul><p>Rename the file(s) or add the year of the movie to the file name and try again.</p><div step-id="3" class="button step" id="installButton" style="left:10px">Try Again</div><div step-id="6" class="button step" id="installButton">Skip</div>',t(messageContent).html(i)}}),progressBar=setInterval(function(){var e="",a={"function":"getInserted"};o(a,"GET",!1).done(function(a){var i=$movieContainer.attr("data-total");e=Math.round(a.inserted/i*100),t(messageContent).find(".progress-in").css("width",e+"%"),t(messageContent).find(".progress-val").html(e+"%"),e>=100&&(clearInterval(progressBar),plugin.installationProcess("6"))})},1e3)},updateMovies:function(){var e='<p>Scanning for new content and fetching the information please wait...<p><div class="progress"><span class="progress-bar"><div class="loader"></div></span></div><br><br><p>Don\'t close this window and wait until the script is finished.</p>',a='<i class="fa fa-database"></i> Update';r(e,a);var i={"function":"updateFiles"};o(i,"GET",!1).done(function(a){if(a.not_found){var i=a.files;e="<p>The script was not able to fetch information for the following file(s):</p><ul>";for(var s=0;s<i.length;s++)e+="<li>"+i[s].file+"</li>";e+='</ul><p>Rename the file(s) or add the year of the movie to the file name and try again.</p><div step-id="7" class="button step" id="installButton" style="left:10px">Try Again</div><div step-id="6" class="button step" id="installButton">Skip</div>'}a.updated?e='<p>Your movies have been added to the database successfully!</p><p>You can turn the auto-update function on and off in the settings menu.</p><div step-id="4" class="button step" id="installButton">Finish</div>':a.not_found||a.updated||(e='<p>The script hasn\'t found any new files in the content directory. Everything is up-to-date.</p><div step-id="4" class="button step" id="installButton">Finish</div>'),t(messageContent).html(e)})},cleanDatabase:function(){var e='<pCleaning up the database please wait...<p><div class="progress"><span class="progress-bar"><div class="loader"></div></span></div><br><br><p>Don\'t close this window and wait until the script is finished.</p>',a='<i class="fa fa-eraser"></i> Clean Up';r(e,a);var i={"function":"cleanDatabase"};o(i,"GET",!1).done(function(a){var i=a.cleaned;e=i>0?"<p>The script was able to remove "+i+' entries successfully!</p><div step-id="4" class="button step" id="installButton">Finish</div>':'<p>The script hasn\'t found any entries to delete.</p><div step-id="4" class="button step" id="installButton">Finish</div>',t(messageContent).html(e)})},showSettings:function(){var t={"function":"getSettings"};o(t,"GET",!1).done(function(t){var e=t.password?"checked":"",a=0!=t.auto_update?"checked":"",i=0!=t.auto_clean?"checked":"",s=t.batch,n='<i class="fa fa-cog"></i> Settings',o='<form><label><span>Auto update </span><input id="autoUpdate" type="checkbox" '+a+'/></label><label><span>Auto Clean </span><input id="autoClean" type="checkbox" '+i+'/></label><label><span>Password  </span><input id="passwordField" type="checkbox" '+e+'/></label><label id="enterPassword"><span>Enter your password  </span><input id="passwordInput" type="password"/> <small class="error"></small></label><label><span>Batch per page </span><input id="batchInput" type="text" value="'+s+'"/></label></form><div class="button-group"><div step-id="5" class="button setting install" id="installButton"><i class="fa fa-cube"></i> Re-Install</div><div step-id="7" class="button setting update" id="installButton"><i class="fa fa-database"></i> Update</div><div step-id="8" class="button setting clean" id="installButton"><i class="fa fa-eraser"></i> Clean Up</div></div><div class="button step" id="saveSettings">Save & Exit</div>';r(o,n)})},saveSettings:function(){var e={},a=t("#passwordInput"),i=t("#passwordField"),s=t("#batchInput"),n=t("#autoUpdate"),l=t("#autoClean"),r=a.val(),c=s.val();if(i.is(":checked")&&a.is(":visible")){if(!(r.length>4))return a.css("border","2px solid #F94F6A"),!1;e.password=r,a.css("border","0px")}if(0==c.length)return s.css("border","2px solid #F94F6A"),!1;e.batch=c,s.css("border","0px"),e.auto_update=n.is(":checked")?1:0,e.auto_clean=l.is(":checked")?1:0;var p={"function":"updateSettings",settings:e};response=o(p,"POST",!1).done(function(t){t.updated&&d()})},showLogin:function(){var t='<p><div class="api-key"> <span class="fa fa-key"></span> <input id="passwordInput" type="password" placeholder="Enter your password"></div></p><div class="button step" id="loginConfirm">Login</div>',e='<i class="fa fa-user"></i> Login';r(t,e)},verifyPassword:function(){var e=t("#passwordInput").val(),a=!1;if(e){var i={"function":"verifyPassword",password:e};o(i,"POST",!1).done(function(t){return t.correct?(d(),!1):void 0})}return e&&a?void 0:(t("#passwordInput").css("border","2px solid #F94F6A"),!1)}},t.fn[c]=function(e){return this.each(function(){t.data(this,"plugin_"+c)||t.data(this,"plugin_"+c,new n(this,e))})}}(jQuery,window,document);